# Migration Data Toolkit (md-toolkit) - sync-diff-inspector Module
The ``sync-diff-inspector`` module of ``md-toolkit`` is an automated configuration generator designed to verify data consistency between MySQL and TiDB. It addresses the complexities of sharding, continuous data replication (DM), and schema transformations, eliminating the manual overhead of writing complex ``TOML`` configuration files for hundreds or thousands of tables.
## Background
Verifying data consistency in a sharded environment is challenging because:
- Complex Mapping: Manually defining table-rules for thousands of source shards is labor-intensive.
- Online Comparison Noise: Since data is constantly replicating, a single comparison snapshot often shows "inconsistency" that is simply replication lag.
- Schema Evolution: When consolidation patterns add metadata columns (like c_schema), standard diff tools fail unless specific ignore-columns are defined.
## Key Features
### AI-Driven Pattern Recognition
The tool uses DeepSeek LLM to analyze source and target schemas to automatically identify sharding patterns (e.g., table_[00-15].users).
- Validation Loop: After DeepSeek proposes a pattern, the tool uses the sync-diff-inspector internal parser to verify it.
- Self-Healing: If the pattern fails verification, the tool re-prompts the LLM with the error logs until a valid configuration is achieved.
### Automatic Rule Generation
- DDL Match: The tool performs a DDL comparison between source and target. It automatically generates the [[source-database.instance.route-rules]] for one-to-one and multiple-to-one mappings.
- Conflict Resolution Handling: If the migration pattern introduced metadata columns (e.g., c_source, c_schema, c_table) to resolve PK conflicts, the tool automatically adds these to the ignore-columns list to prevent false-positive mismatches.
### Iterative "State-Aware" Comparison
To handle online migrations where data is continuously flowing via DM:
- Incremental Diffing: The tool reads the output (checkpoints) of previous sync-diff-inspector runs.
- Smart Filtering: It only generates configuration for tables that failed the last check.
- Convergence Logic: Once all tables pass the diff, the tool triggers a final verification to guarantee absolute consistency before cutover.
## Specifications
### Command
```
./bin/md-toolkit --config config/config.yaml --ops-type generateSyncDiffconfig --llm deepseek
```
### Usage Example
- Input Configuration (config/config.yaml)
The tool uses the same centralized configuration as the Dumpling module to maintain a "Single Source of Truth."
```
SourceDB:
  - Name: instance01
    Host: 10.0.1.5
    Port: 3306
    User: dmuser
    Password: 1234Abcd
    DBs: [messagedb_00, messagedb_01, ..., messagedb_07]
  - Name: instance02
    Host: 10.0.1.6
    Port: 3306
    User: dmuser
    Password: 1234Abcd
    DBs: [messagedb_08, messagedb_09, ..., messagedb_15]

DestDB:
  Name: targetDB
  Host: 10.0.1.4
  Port: 4000
  User: root
  Password: 1234Abcd
  DBs: [messagedb]
```
- Generated Configuration Output (sync_diff.toml)
The tool automatically produces a ready-to-use file:
```
# Auto-generated by md-toolkit
check-thread-count = 4
export-fix-sql = true

[[source-db]]
host = "10.0.1.5"
port = 3306
user = "dmuser"
password = "..."
instance-id = "instance01"

[[source-db]]
host = "10.0.1.6"
port = 3306
user = "dmuser"
password = "..."
instance-id = "instance02"

[target-db]
host = "10.0.1.4"
port = 4000
user = "root"
password = "..."

[[table-config]]
target-struct = "messagedb"
target-table = "users"
# Auto-ignored metadata columns from Pattern 3
ignore-columns = ["c_source", "c_schema", "c_table"]
# Auto-generated route rules via DeepSeek/DDL match
source-tables = [
    {instance-id = "instance01", source-schema = "messagedb_[0-7]", source-table = "users"},
    {instance-id = "instance02", source-schema = "messagedb_[8-15]", source-table = "users"}
]
```
